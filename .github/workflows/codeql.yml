name: "CodeQL Security Scan"
on: [push, pull_request]

jobs:
  analyze:
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean CodeQL cache
        run: rm -rf ~/.codeql || true

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3.24.10
        with:
          languages: 'php'
          build-mode: none
          tools: latest 

      - name: Install PHP dependencies
        run: |
          if [ -f composer.json ]; then 
            composer install --no-dev --no-interaction
          fi

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3.24.10
        with:
          category: "/language:php"